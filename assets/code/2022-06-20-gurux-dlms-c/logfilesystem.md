# 存储相关

## flash 日志系统

### 新数据添加

不影响其他数据，可直接写入

### 老数据修改或覆盖

需要擦除所在 sector，影响同 sector 其他数据

常规做法是备份后擦除 sector，然后重新写入备份及新数据

可以和日志系统结合，使用异步处理方式对同个 sector 的多个操作进行合并

10 组日志记录，每组最多 8 条日志记录，每条最多 5 个操作，等长。共 2048 个 sector，通过散列函数对应到 10 组日志记录中。

日志结构：

- sector 序号(作为开始标记，>0：存在记录，=0：记录失效，=0xFFFF：未使用)
- 日志操作主体
- 日志操作结束标识
- 日志继续标记（是否有后续操作）
- ...余下 4 个操作

日志组管理结构：

- 使用标记（8 位，每位对应一条日志记录）
- 结束标记（8 位）

当日志达到`最大操作数`或达到`强制同步时间`或有`同组其他sector的操作`或有`对这个sector的读取`时，需要同步一次，将日志内容写入最终位置。

同步时，整理各个操作顺序，实现一次写入。之后为该条日志添加结束标记

当一组内所有日志记录都使用完时，全部日志记录同步一次，直到没有正在使用的日志，擦除存放日志的 sector，重新写入

## 备份问题

ee 备份至 flash

分页备份，每页 64Kbytes

- 62+2

56 字节加两位校验码

写时复制

5 个 4k 块分为`20个物理页`，每页为 4096/4=1024 字节

其中对外呈现为`8个虚拟页`，其中的每页映射到 20 个页中的某一页，可以任意修改，

每次修改这种`虚拟页`，底层做写时复制，在 20 个物理页中选新页存放修改后的虚拟页，页表映射修改为新页。修改前的物理页被回收

为了实现擦写均衡，需要设计算法在必要时回收正在使用物理页，以便该页所在的块能被全擦除

页表构造如下：

| 物理页 | 虚拟页 |
| :----: | :----: |
|   0    |   1    |
|   1    |   3    |
|   2    |   5    |
|   3    |   0    |
|   4    |   1    |
|   5    |   0    |
|   6    |   7    |
|   7    |        |
|   8    |        |
|   9    |        |
|   10   |        |
|   11   |        |
|   12   |        |
|   13   |        |
|   14   |        |
|   15   |        |
|   16   |        |
|   17   |        |
|   18   |        |
|   19   |        |

由于写时复制的应用，物理页按顺序写入，所以更新虚拟页一栏即可，如虚拟页 1 经历了两次修改，第一次置于物理页 0，第二次置于物理页 4。则物理页 4--虚拟页 1 映射有效，物理页 0--虚拟页 1 映射无效。通过扫描页表可以得到当前页映射关系

对于使用，可以将整个页读入内存，并建立页 cache 机制，提高效率。写入时也使用写时复制技术，对页 cache 内的页修改时同步写入虚拟页。

## EE 的一致性实现

eeprom 共 32KB，512 页，每页 64B

页信息如下：

| 物理页 | 说明    |
| -----: | :------ |
|      0 | reserve |
|      1 | L1_v1   |
|      2 | L2_v1   |
|      3 | L3_V1   |
|    ... | ...     |
|    494 | L494_v1 |
|    495 | super   |
|    496 | tmp     |
|    497 | tmp     |
|    498 | tmp     |
|    ... | ...     |
|    511 | tmp     |

- **L`X`\_v`Y`**
  `X` 表示逻辑页序号，共 494 个，从 1 到 494，`Y` 表示版本号，初始为 1，每次修改页加一。初始状态，逻辑页与物理页一一对应，物理页存放对应逻辑页最新版本

- **super page**
  超级页，用于记录日志，包括每个 tmp 页当前的状态。单条记录共 4 字节 32 位，共 16 条记录，对应 16 个 tmp 页

  | tmp 页序号 | 后续标志:1 | 计数器:5 | 逻辑页序号:10 | CRC:16 |
  | :--------: | :--------: | :------: | :-----------: | :----: |
  |    496     |     1      |    1     |       3       |  ...   |
  |    497     |     0      |    1     |       2       |  ...   |
  |    498     |     0      |    2     |      497      |  ...   |
  |    ...     |    ...     |   ...    |      ...      |  ...   |
  |    511     |     0      |    0     |       0       |  ...   |

  - **tmp 页序号**
    无需保存，依赖逻辑顺序对应 tmp 页

  - **后续标志**
    占 1 位，表示该记录是否是一个事务中最后一个，0 表示最后一个，1 表示还有后续

  - **计数器**
    占 5 位，表示事务序号，开始新的事务，则加 1，事务序号相同表示是同一个事务内的动作。如果一个事务为最新事务(序号最大)，且不包含后续标志为 0 的记录，则该事务内所有记录无效

  - **逻辑页序号**
    表示当前 tmp 页存放的逻辑页的序号。

    - =0
      记录无效，逻辑页对应的物理页存放的数据为最新版本

    - \>0 且<=494:
      表示 tmp 页当前存放的对应逻辑页的最新版本，该逻辑页对应的物理页存放的数据无效

    - \>=496 且<=511：
      表示无效对应 tmp 页的记录信息，该逻辑页对应的物理页存放的数据为最新版本

  - CRC
    CRC16 校验，防止记录未写成功导致数据错乱。校验错表示该记录无效

- **tmp 页**
  临时页，用于和物理页做交换。根据写时复制原理，修改后的页需要存放在与原有页不同的地方，从而保证一致性(原子修改)。

根据 super page 构造内存中的`临时页表`：

| tmp 页序号 | 逻辑页序号 |
| :--------: | :--------: |
|    496     |     3      |
|    497     |     2->0   |
|    498     |     0      |
|    ...     |     0      |
|    511     |     0      |

> 由于498存放了撤销497的操作，该步操作表示新数据写于物理页2上，此时497存放页非最新，故置为无效

修改某逻辑页操作为：

1. 根据内存临时页表获取下一条记录信息，如499，
1.1 如果对应逻辑页序号为0，则说明该页为空，可以直接使用；
1.2 如果不为0，表示该页存放着最新的逻辑页，需要将数据回写回对应物理页，将记录和页表逻辑页序号置0
2. 查找内存临时页表，寻找该逻辑页的序号
2.1 如果找不到序号，则将修改后的新页写入下一条记录对应的tmp页，再将该记录的逻辑页序号修改为对应的序号，页表中的逻辑页序号同步置该序号
2.2 如果找到序号，则先将新页写入对应物理页，再在下一条记录中将逻辑页序号修改为该tmp页序号，表示将该记录置为无效，页表中的逻辑页序号同步置0

该方案中super page相当于日志记录用的超级块，且该日志存放的数据虽然是临时的，但却可以方便的进行读取，而无需回写回物理页再读取。

## 电量

- 电量
  每种电量由三类属性描述，类型、相位、费率：
  - 类型
    - 有功
      - 正向
      - 反向
      - ...
    - 无功
      - 正向
      - 反向
      - 四象限
      - ...
    - 视在
      - 正向
      - 反向
      - ...
  - 相位
    - A
    - B
    - C
    - 总
  - 费率
    - 总
    - 分（8个）

  类型、相位、费率联合唯一

- 相位

  由于读取延迟和尾数的存在，无法保证按顺序读到的近似同一时间的A+B+C=总。

- 脉冲
  根据电表计量芯片的计量精度（脉冲常数），每消耗一定电量产生一个脉冲

  如脉冲常数2000imp/kWh，表示每度2000个脉冲，每个脉冲表示1/2000kWh=0.0005kWh=0.5Wh，假设增量寄存器读出来是7脉冲，表示3.5Wh

- 尾数增量
  存放从增量寄存器中中读取的增量之和，`每秒`读一次，累加到本变量，当达到0.01度时为`0.01度增量`递增，本变量刷新

  增量寄存器位于计量芯片，每次被读取后清零，表示从上一次读取到本次读取间电量的增量

- 0.01度(10W·h)增量
  存放增量，每0.01度为该变量增加计数，步进为1。被读取并叠加到总量后清0

  ee保存条件：
  - 热复位

  冷复位会导致数据丢失

  使用CRC16校验保证数据完整性

  关于热复位（复位引脚电平变化，看门狗复位，或者软件复位）时，内存中的值是否可视为未变化。因为RAM此时并未断电，只是发生了MCU的reset，导致电表程序从程序入口开始重新运行。这样可以使用复位前的相同位置的RAM继续使用。

- 总量
  存放总量，存放在ee中，由`0.01度增量`叠加

  更新条件：
  - 15分钟定时
  - 费率切换时

- 费率
  费率分为总费率和分费率，分费率间互斥，同时只有一个费率启用。所以只需在内存中保存一个费率对应的电量（增量或总量，目前是增量，总量占用空间较大）。
  
## 必须保存的参数

- 电量
- 事件状态
  某动作持续发生一段时间后才记录事件

  
  
- 电费
  电费是由电量和费率计算得到，电费与电量的一致性保证
- IC
  频率视通信频次而定

  可考虑和电量相同的保存方式

## 调度

QP状态机

## DLMS 通信协议栈

## 硬件适配层
