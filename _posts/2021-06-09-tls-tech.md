---
title: "传输层安全(TLS)相关技术详解"
author: Jinkai
date: 2021-06-09 09:00:00 +0800
published: true
categories: [技术]
tags: [DH, SSL/TLS, https]
---

## TLS的目标

传输层安全(TLS)是网络安全的主力。它允许网站向 Web 浏览器证明其身份，并保护所有交换的信息被加密且免受窥探。

TLS 有两个主要目标：`保密性`和`身份验证`。两者对于在互联网上进行安全通信都至关重要。保密性主要由密钥安全交换技术和AES加密算法实现，身份验证主要由数字签名技术实现

## 保密性

### 对称密钥

像RSA和DH这样的公共关键算法使用大量的CPU，是TLS握手中最慢的部分。笔记本电脑每秒只能执行`几百个` RSA 加密，而对称密码 AES 的加密量约为 `1000 万/秒`。

所以应用报文的加密使用的是对称加密技术，而RSA和DH仅用于对称密钥的交换。

在 TLS 中，这种对称加密通常使用强大的块密码（如`AES`）完成。较旧的浏览器和平台可能会使用密码，如`3DES`或流密码`RC4`，这在现在被认为是不安全的。

### RSA密钥交换

RSA密钥交换是目前最主流的密钥交换方式，握手方式如下：

![RSA握手](/assets/img/2021-06-09-diffie-hellman/rsa-handshake.jpg)

RSA密钥交换主要是用公钥加密对称密钥后传输，对方用私钥解密的过程

RSA算法的本质是利用了一个数学原理：**将两个大质数相乘非常容易，但要对其乘积进行因式分解却非常困难**，详见[RSA加密算法维基百科](<https://zh.wikipedia.org/wiki/RSA%E5%8A%A0%E5%AF%86%E6%BC%94%E7%AE%97%E6%B3%95>)

### Diffie-Hellman密钥交换

DH算法解决了密钥在双方`不直接传递密钥`的情况下完成密钥交换，这个神奇的交换原理完全由数学理论支持。

![DH握手](/assets/img/2021-06-09-diffie-hellman/dh-handshake.jpg)

我们来看DH算法交换密钥的步骤。假设甲乙双方需要传递对称密钥，他们之间可以这么做：

甲首选选择一个素数`p`，例如`509`，底数`g`，任选，例如5，随机数`a`，例如123，然后计算`A=g^a mod p`，结果是215，然后，甲发送p＝509，g=5，A=215给乙；
乙方收到后，也选择一个随机数`b`，例如，456，然后计算`B=g^b mod p`，结果是181，乙再同时计算`s=A^b mod p`，结果是121；
乙把计算的B=181发给甲，甲计算`s＝B^a mod p`的余数，计算结果与乙算出的结果一样，都是121。

所以最终双方协商出的密钥s是121。注意到这个密钥s并没有在网络上传输。而通过网络传输的p，g，A和B是无法推算出s的，因为实际算法选择的素数是非常大的。

所以，更确切地说，DH算法是一个密钥协商算法，双方最终协商出一个共同的密钥，而这个密钥不会通过网络传输。

    DH算法的安全性

    数字可以分为两大部分：
    不可再分的数：prime number 质数
    可以再分的数：composite number 和数

    每个数字可以描述为一个“锁”
    每个数字有且只有一种质因数分解，把质因数分解看做是“钥匙”，任何两个数的质因数分解都不同。

    对于锁，有一个基本的要求：朝一个方向容易，朝反方向难。one-way function单向函数。
    在数学中，模算术（时钟算术）就是一个单向函数 X MOD P，如果P选择为质数，那么其值会在时钟上（1到P-1上）等可能均匀分布。
    正向计算3^x mod 17 = ？很容易
    反向计算3^? mod 17 = 12不容易，比如说P选择一个数百位的质数，那么想求出？只能采用试错法

    在DH算法握手的过程中，指数不会被传递，也就是说指数是需要被破解的对象

详见[迪菲-赫爾曼密鑰交換维基百科](<https://zh.wikipedia.org/wiki/%E8%BF%AA%E8%8F%B2-%E8%B5%AB%E7%88%BE%E6%9B%BC%E5%AF%86%E9%91%B0%E4%BA%A4%E6%8F%9B>)

### DHE密钥交换

固定一方的私钥有被破解的风险，那么干脆就让双方的私钥在每次密钥交换通信时，都是随机生成的、临时的，这个方式也就是 DHE 算法，E 全称是 ephemeral（临时性的）。

### ECDHE密钥交换

DHE 算法由于计算性能不佳，因为需要做大量的乘法，为了提升 DHE 算法的性能，所以就出现了现在广泛用于密钥交换算法 —— ECDHE 算法。

ECDHE 算法是在 DHE 算法的基础上利用了 ECC 椭圆曲线特性，可以用更少的计算量计算出公钥，以及最终的会话密钥。

小红和小明使用 ECDHE 密钥交换算法的过程：

双方事先确定好使用哪种椭圆曲线，和曲线上的基点 G，这两个参数都是公开的；
双方各自随机生成一个随机数作为私钥d，并与基点 G相乘得到公钥Q(Q = dG)，此时小红的公私钥为 Q1 和 d1，小明的公私钥为 Q2 和 d2；
双方交换各自的公钥，最后小红计算点(x1，y1) = d1Q2，小明计算点(x2，y2) = d2Q1，由于椭圆曲线上是可以满足乘法交换和结合律，所以 d1Q2 = d1d2G = d2d1G = d2Q1 ，因此双方的 x 坐标是一样的，所以它是共享密钥，也就是会话密钥。

这个过程中，双方的私钥都是随机、临时生成的，都是不公开的，即使根据公开的信息（椭圆曲线、公钥、基点 G）也是很难计算出椭圆曲线上的离散对数（私钥）。

具体算法详见[椭圆曲线迪菲-赫尔曼金钥交换维基百科](<https://zh.wikipedia.org/wiki/%E6%A9%A2%E5%9C%93%E6%9B%B2%E7%B7%9A%E8%BF%AA%E8%8F%B2-%E8%B5%AB%E7%88%BE%E6%9B%BC%E9%87%91%E9%91%B0%E4%BA%A4%E6%8F%9B>)

## 身份验证

### 数字签名

RSA算法和DH算法都需要交换公钥，如何保证公钥没有被中间人篡改，也是握手过程中需要解决的问题。

*TODO:签名算法涉及的东西也很多，现在还没有学习完，等待后续补充*

![DH握手](/assets/img/2021-06-09-diffie-hellman/dh-handshake.jpg)

### RSA签名

常用数字签名算法有：

- MD5withRSA
- SHA1withRSA
- SHA256withRSA

它们实际上就是指定某种哈希算法进行RSA签名的方式。

#### DSA签名

除了RSA可以签名外，还可以使用DSA算法进行签名。DSA是Digital Signature Algorithm的缩写，它使用ElGamal数字签名算法。

DSA只能配合SHA使用，常用的算法有：

- SHA1withDSA
- SHA256withDSA
- SHA512withDSA

和RSA数字签名相比，DSA的优点是更快。

#### ECDSA签名

椭圆曲线签名算法ECDSA：Elliptic Curve Digital Signature Algorithm也是一种常用的签名算法，它的特点是可以从私钥推出公钥。比特币的签名算法就采用了ECDSA算法，使用标准椭圆曲线secp256k1。

## 参考

[Keyless SSL: The Nitty Gritty Technical Details](<https://blog.cloudflare.com/keyless-ssl-the-nitty-gritty-technical-details/>)
[图解 ECDHE 密钥交换算法](<https://www.cnblogs.com/xiaolincoding/p/14318338.html>)
[迪菲-赫爾曼密鑰交換维基百科](<https://zh.wikipedia.org/wiki/%E8%BF%AA%E8%8F%B2-%E8%B5%AB%E7%88%BE%E6%9B%BC%E5%AF%86%E9%91%B0%E4%BA%A4%E6%8F%9B>)
[RSA加密算法维基百科](<https://zh.wikipedia.org/wiki/RSA%E5%8A%A0%E5%AF%86%E6%BC%94%E7%AE%97%E6%B3%95>)
[椭圆曲线迪菲-赫尔曼金钥交换维基百科](<https://zh.wikipedia.org/wiki/%E6%A9%A2%E5%9C%93%E6%9B%B2%E7%B7%9A%E8%BF%AA%E8%8F%B2-%E8%B5%AB%E7%88%BE%E6%9B%BC%E9%87%91%E9%91%B0%E4%BA%A4%E6%8F%9B>)
