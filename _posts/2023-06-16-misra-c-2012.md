---
title: "MISRA C:2012 嵌入式C规范解读"
author: Jinkai
date: 2023-06-16 09:00:00 +0800
published: true
categories: [技术]
tags: [misra, MISRA C:2012]
---

## 总览

MISRA C 指南定义了一个 C 语言的子集，在这个子集中，犯错的机会被消除或减少，程序可靠性得到提高。

MISRA C 发展历史:

1. `MISRA C:1998` – 第一版（汽车行业的原始指南）
2. `MISRA C:2004` – 第二版（考虑了用户反馈和跨行业应用）
3. `MISRA C:2012` – 第三版（包含对 C99 语言功能的支持，改进的强类型模型，分析关键字）
   - `MISRA C:2012` (Feb 2019) – 第三版第一次修订（纳入了额外的安全准则），纳入了第 1 次修正案（AMD1）和技术更正 1（TC1） – 也称为 `MISRA C:2019`
   - `MISRA C:2023` (Apr 2023) – 第三版第二次修订（包含对 C11 和 C18 语言功能的支持），纳入了第 2 次（AMD2）、第 3 次（AMD3）和第 4 次（AMD4）修正案，以及技术更正 2（TC2）。

本文将介绍第三版的初稿，也就是`MISRA C:2012`。

## 背景

### C 语言优势

C 编程语言很受欢迎，因为：

- C 语言编译器可用于**许多处理器**；
- C 语言程序可被编译为**高效**的机器代码；
- 它由**国际标准**（ISO）定义；
- 它提供了访问目标处理器的输入/输出能力的机制，无论是**直接访问**还是通过**语言扩展**；
- 在关键系统中使用 C 语言有大量的**经验**；
- 它被**静态分析**和**测试工具**广泛支持。

### C 语言缺陷

#### 语言定义

ISO 标准并没有完全规范 C 语言，而是故意将某些方面放到**实现时**由程序员(编译器)自己去定义，从而让 C 语言变得更加灵活以支持不同的处理器。

这会导致某些行为变得不可预测，这对嵌入式领域的可靠性要求是致命的。

例子：

```c
if ( ishigh && (x == i++))
```

在上面这个例子中，该语句的执行会因编译器的不同产生不同的结果：

- `ishigh` 为否时，后一个表达式不判断，`i`不变
- `ishigh` 为否时，后一个表达式也判断，`i`增加 1

这就需要程序员对编译器特性非常熟悉(但还是避免不了失误)，且该代码的**可移植性**也会很差

#### 语言误用

编程过程中可能会出现连程序员自己也没发觉的失误：

```c
if (a == b) /* 判断a和b是否相等 */
if (a = b) /* 将b赋值给a，并判断a是否为非0 */
```

这种情况一般是把 `a == b` 误写成 `a = b` 了，但对编译器来说它们都合法，无法判断错误。

> 不过现在的静态检查工具在编程时就能检查出这种情况，给出 warning

#### 语言误解

C 语言有很多运算符，虽然标准规定了运算符的优先级，但比较难记忆，可能在编程中混淆了部分运算符的优先级。

C 语言不是强类型语言，其类型可以隐式转换，也就是操作产生的数据类型和操作数类型可能不同。

#### 运行时(Run-time)错误检查

C 语言程序可以被编译成小而有效的机器代码，但其代价是运行时检查的程度非常有限。

C 语言程序一般不提供对常见问题的运行时检查，如算术异常（如除以 0）、溢出、指针的有效性或数组边界错误。

C 语言的理念是，程序员有责任明确地进行这种检查。

## 工具选择

### C 标准和编译器选择

`MISRA C:2012` 基于`ISO/IEC 9899:2011 [14]`(C99)和`ISO/IEC 9899:1990 [2]`(C90)标准编写

根据项目需求选择 C99 或 C90 标准

> 写者注：原文的一些介绍已经过时，这里就不写了，比如他认为当前编译器对 C99 的支持普遍不好，实际上现在(2023 年)大多数的编译器都已经能较好的支持 C99 了，对于新项目，建议无脑选 `GCC` 就行

### 代码分析工具

> 写者注：本节将由写者根据项目经验列出推荐的工具

这里推荐使用开源的[cppcheck](https://cppcheck.sourceforge.io/)搭配[misra 插件](https://cppcheck.sourceforge.io/misra.php)，只需在安装 cppcheck 时勾选安装 addons，然后搭配 vscode 中的[cpp-check-lint](https://marketplace.visualstudio.com/items?itemName=QiuMingGe.cpp-check-lint)插件和规则描述文件(规则描述文件可以在 github 上找找，毕竟有版权不能随便共享)

当然如果有充足的资金可以选择购买专业的静态检查工具，[List of tools for static code analysis - Wikipedia](https://en.wikipedia.org/wiki/List_of_tools_for_static_code_analysis)网站上列出了所有主流的静态检查工具，搜索`"misra"`即可找到支持 misra 的检查工具。

## 必备知识

开发者应具备嵌入式、高集成、高安全性编程基础，并了解使用的编译器和静态检查工具。

## 使用 MISRA C

MISRA C 应该从项目一开始便使用，如果是为了符合 MISRA C 而对已有项目大规模修改会造成不可预估的问题，注意评估好这么做的风险。

因在代码审核和单元测试前检查代码是否符合 MISRA C。

MISRA C 不提供任何与**编程风格**相关的建议。

注意编译器优化选项，平衡目标文件大小和缺陷风险。

### 偏离标准

允许为了某些特殊情况偏离标准，比如将 int 类型值强制转为指针来实现访问内存地址空间映射的 I/O 端口:

```c
// 内存中的0x0002地址内数据映射了某一I/O端口数据
#define PORT (*(volatile unsigned char *)0x0002)
// 修改该位置数据就相当于修改了该I/O端口数据
PORT = 0x10u;
```

需要有专门的方式记录这种不得不违反 MISRA C 的地方。最好不要有这种地方。

## 准则介绍

每项 MISRA C `准则(guidelines)`都被分为 "`规则(Rule)`"或 "`指示(Directive)`":

指示是指无法提供必要的完整描述来进行合规性检查的准则。为了能够执行检查，需要额外的信息，如设计文档或需求规格中可能提供的信息。静态分析工具可以帮助检查是否符合指示，但不同的工具对不符合指示的解释可能大相径庭。

规则是对要求进行完整描述的准则。检查源代码是否符合规则应该是可能的，而不需要任何其它信息。特别是，静态分析工具应该能够检查规则的合规性，但必须遵守第 6.5 节中描述的限制。

> 注意后续的准则、规则、指示名词

### 准则分类

每条准则被分为:

- `强制(mandatory)`：不允许违反
- `要求(required)`：只有在有明确限制、要求和预防措施的偏离情况下才能违反
- `建议(advisory)`：在合理可行的范围内遵循建议

他们的重要程度相同，区别只是是否允许[偏离标准](#偏离标准)

### 可判定性(Decidability)

规则(Rule)分为`可判定的(decidable)`和`不可判定的(undecidable)`:

- 可判定的: 可由静态分析工具明确给出是否符合 MISRA C 的结论(是或否)
- 不可判定的: 不能给出明确结论，比如有些需要在编译、连接阶段或运行时才能分析出
