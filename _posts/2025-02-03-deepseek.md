---
title: "DeepSeek ç¬”è®°"
date: 2025-02-03 08:00:00 +0800
published: true
mermaid: true
math: true
categories: [æŠ€æœ¯]
tags: [AI, transformer]
---

## æ¶æ„

![alt text](/assets/img/2025-02-03-deepseek/image-3.png)

## Multi-Head Latent Attention

ä¸»è¦ä½œç”¨æ˜¯åŠ é€Ÿæ¨ç†ã€‚

### kv cache

åœ¨ä¹‹å‰çš„ transformer æ¶æ„ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ° Decoder å®é™…æ˜¯ä¸€ä¸ª auto-regressive çš„æ¨¡å‹ï¼Œ**æ¨ç†**æ—¶ä¸ºäº†å®ç° auto-regressiveï¼Œæ¯ä¸ª token ç”Ÿæˆæ—¶éƒ½éœ€è¦å‰é¢æ‰€æœ‰å·²ç»ç”Ÿæˆçš„ token ä¿¡æ¯ï¼Œè¿™æ ·å°±é¿å…ä¸äº†å¤§é‡çš„é‡å¤è®¡ç®—ã€‚è¿™é‡Œçš„é‡å¤è®¡ç®—ä¸»è¦æ˜¯æŒ‡ token å˜ä¸º key å’Œ value çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯ Embedding å’Œ Positional Encodingï¼ˆè§[Transformer æ¶æ„å›¾](/posts/transformer/#%E6%9E%B6%E6%9E%84)ï¼‰ã€‚

é€šè¿‡å°†è¿™äº›å·²ç»ç”Ÿæˆè¿‡çš„ key å’Œ value çŸ©é˜µä¿å­˜ä¸‹æ¥ç”¨äºä¹‹åçš„æ¨ç†ï¼Œä¹Ÿå°±æ˜¯ kv cache çš„ä½œç”¨ã€‚cache å¸¦æ¥å¦‚ä¸‹å¥½å¤„ï¼š

1. è®¡ç®— $k_t$ å¯ä»¥åˆ©ç”¨ $k_{t-1}$ çš„çŸ©é˜µï¼Œåœ¨å…¶ä¸Šåšä¸€æ¬¡ concatenate é™„åŠ å½“å‰çš„ token è®¡ç®—ä¿¡æ¯å³å¯ï¼Œå¦‚æœ $k_{t-1}$ å·²ç»è¢«ç¼“å­˜ä¹Ÿå°±æ˜¯æ— éœ€é‡å¤è®¡ç®—ï¼Œè¯¥æ“ä½œçš„æ•ˆç‡å°†å¤§å¤§æå‡ã€‚$v_t$ åŒç†ã€‚
2. å½“æ¨ç†æ—¶é‡åˆ°ç›¸åŒ $k_t$ æ—¶å¯ä»¥åˆ©ç”¨ä¹‹å‰ä¿å­˜çš„ cache è€Œä¸ç”¨é‡å¤è®¡ç®—ã€‚$v_t$ åŒç†ã€‚

ä½†æ˜¯è¿™ç§ç®€å•çš„è§£å†³æ–¹æ¡ˆæ— éæ˜¯ç©ºé—´æ¢æ—¶é—´ï¼Œå¸¦æ¥çš„é—®é¢˜å°±æ˜¯æ¶ˆè€—äº†å®è´µçš„å†…å­˜ã€‚

![alt text](/assets/img/2025-02-03-deepseek/image-2.png)

MLA å°±æ˜¯ç”¨æ¥è§£å†³ MHA ä¸­çš„ kv cache è¿‡å¤§çš„é—®é¢˜ï¼ŒåŸç†å¾ˆç®€å•ï¼ŒåŸæ¥ Multi-Head Attention ä¸­æ˜¯æŠŠ queryã€keyã€value åˆ†åˆ«æŠ•å½±åˆ°å„è‡ªçš„è‹¥å¹²ä¸ªä½ç»´ç©ºé—´ä¸­ï¼ˆè§[Multi-Head Attention](/posts/transformer/#multi-head-attention)ï¼‰ï¼Œå‡è®¾ $h_t$ è¡¨ç¤ºè¾“å…¥åºåˆ—ä¸­çš„ç¬¬ t ä¸ª tokenï¼Œç”± Attention çš„ç†å¿µå¯çŸ¥å¯¹äº query,key,value æ¥è¯´è¿™ä¸ªå€¼æ˜¯ç›¸åŒçš„ï¼Œç”± MHA çš„å®šä¹‰å¯çŸ¥å®ƒä»¬çš„æŠ•å½±çš„å‚æ•°($ğ‘Š^{ğ‘„}$,$ğ‘Š^{K}$,$ğ‘Š^{V}$)ä¸åŒï¼Œæ‰€ä»¥ç»è¿‡æŠ•å½±åçš„ç»“æœå„ä¸ç›¸åŒ:

$$
q_ğ‘¡ = ğ‘Š^{ğ‘„}h_ğ‘¡,
$$

$$
k_ğ‘¡ = ğ‘Š^{ğ¾}h_ğ‘¡,
$$

$$
v_ğ‘¡ = ğ‘Š^{ğ‘‰}h_ğ‘¡,
$$

$$
[q_{ğ‘¡,1};q_{ğ‘¡,2};\dots;q_{ğ‘¡,ğ‘›_â„}]=q_ğ‘¡,
$$

$$
[k_{ğ‘¡,1};k_{ğ‘¡,2};\dots;k_{ğ‘¡,ğ‘›_â„}]=k_ğ‘¡,
$$

$$
[v_{ğ‘¡,1};v_{ğ‘¡,2};\dots;v_{ğ‘¡,ğ‘›_â„}]=v_ğ‘¡,
$$

å¯¹ MHA æ¥è¯´æ¯ä¸ª head (åˆ†ç»´åº¦)çš„è¾“å‡ºè®¡ç®—æ–¹å¼å¦‚ä¸‹(æ¯ä¸ª head ä½¿ç”¨ $i$ ä¸‹æ ‡è¡¨ç¤ºï¼Œ $j$ ä¸‹æ ‡è¡¨ç¤ºå½“å‰çš„ $q_t$ éœ€è¦å’Œ t ä½ç½®ä»¥åŠ t ä¹‹å‰æ‰€æœ‰ä½ç½®(1åˆ°t-1)çš„ key è®¡ç®—å…³ç³»ï¼Œè¿™æ˜¯ transformer å®ç° auto-regressive çš„åŸºæœ¬æœºåˆ¶):

$$
\mathbf{o}_{t,i} = \sum_{j=1}^{t} \text{Softmax}_j \left( \frac{\mathbf{q}_{t,i}^T \mathbf{k}_{j,i}}{\sqrt{d_h}} \right) \mathbf{v}_{j,i},
$$

æ‰€æœ‰åˆ†ç»´åº¦çš„ç»“æœè¿›è¡Œæ•´åˆï¼Œå¾—åˆ°ç¬¬ t ä¸ª token çš„ç»“æœï¼š

$$
\mathbf{u}_t = W^O [\mathbf{o}_{t,1}; \mathbf{o}_{t,2}; \dots; \mathbf{o}_{t,n_h}].
$$

å¯¹ MLA æ¥è¯´å°±æ˜¯å°†å…¶ä¸­çš„ $k_t$ å’Œ $v_t$ åˆ†åˆ«å†æ¬¡è¿›è¡Œäº†å‹ç¼©ï¼Œè¿™æ · key å’Œ value ä½œä¸º cache æ—¶æ›´å°:

$$
c^{ğ¾ğ‘‰}_ğ‘¡ =ğ‘Š^{ğ·ğ¾ğ‘‰}h_ğ‘¡,(1)
$$

$$
k^{ğ¶}_ğ‘¡ =ğ‘Š^{ğ‘ˆğ¾}c^{ğ¾ğ‘‰}_ğ‘¡,
$$

$$
v^{ğ¶}_ğ‘¡ =ğ‘Š^{ğ‘ˆV}c^{ğ¾ğ‘‰}_ğ‘¡,
$$

è¿™é‡Œçš„(1)æ˜¯å°† MHA çš„æ˜ å°„å’Œå‹ç¼©è¿›è¡Œäº†æ•´åˆï¼Œä¹Ÿå°±æ˜¯å°†$h_t$(ä¹Ÿå°±æ˜¯é muti-head çš„ attention ä¸­çš„ $k_t$ æˆ– $v_t$)ä½¿ç”¨ $ğ‘Š^{ğ·ğ¾ğ‘‰}$ çŸ©é˜µè¿›è¡Œæ˜ å°„+å‹ç¼©ï¼ˆå°±æ˜¯é™ç»´ï¼ŒD å°±æ˜¯ down é™ç»´ï¼‰å¾—åˆ° $c_t$ ($c$ è¡¨ç¤º cache)ï¼Œè®¡ç®—æƒé‡æ—¶ï¼ŒåŸè¡¨è¾¾å¼ä¸­çš„æ¯ä¸ª head(ç»´åº¦)ä¸­çš„ $k_t$ å’Œ $v_t$ éƒ½å¯ä»¥ä½¿ç”¨æ¯ä¸ª head å¯¹åº”çš„è§£å‹å‚æ•°($ğ‘Š^{ğ‘ˆğ¾}$ å’Œ $ğ‘Š^{ğ‘ˆV}$) å’Œ $c_t$ è¿ç®—å¾—åˆ°(è€Œä¸” $c_t$ æ˜¯ key å’Œ value å…±ç”¨çš„ï¼Œcache çš„å ç”¨ç©ºé—´éå¸¸å°ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå°±æ˜¯ 1/16)ã€‚

æˆ‘ä»¬å…ˆä¸è€ƒè™‘ Positional Encodingï¼Œåœ¨ cache å‘½ä¸­çš„æƒ…å†µä¸‹å¯ä»¥è¿™æ ·è®¡ç®—ï¼š

$$
\mathbf{o}_{t,i} = \sum_{j=1}^{t} \text{Softmax}_j \left( \frac{\mathbf{q}_{t,i}^T ğ‘Š^{ğ‘ˆğ¾}_{i} c^{ğ¾ğ‘‰}_{j}}{\sqrt{d_h}} \right) ğ‘Š^{ğ‘ˆV}_{i} c^{ğ¾ğ‘‰}_{j}
$$

ç°åœ¨è€ƒè™‘ Positional Encodingï¼Œè¿™ä¹ˆåšå°±å¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ï¼ŒMHA ä¸­çš„ $k_t$ å®é™…æ˜¯å¸¦äº†ä½ç½®ä¿¡æ¯çš„(ä¸‹é¢çš„ $k^R_t$ï¼Œ$v_t$ ä¸å¸¦)ï¼Œå› ä¸º transformer æ¶æ„ä½¿ç”¨äº†ç›¸å¯¹ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´ $t_1$ ä½ç½®çš„ $k^R_{t_1}$ ä¼šå› ä¸ºå½“å‰ä½ç½® t çš„ä¸åŒæœ‰ä¸åŒç»“æœï¼Œæ¯”å¦‚åœ¨ $t_2 = t_1 + 1$ï¼Œ$t_3 = t_1 + 2$ï¼Œåœ¨ $t_2$ ä½ç½®å’Œ $t_3$ ä½ç½®è®¡ç®— $k^R_{t_1}$ ä¼šä¸åŒï¼š

$$
k^{R}_{t} = RoPE(W^{KR}h_t)
$$

$$
k_{t,i} = [k^{C}_{t,i};k^R_t]
$$

æ‰€ä»¥åªèƒ½å» cache ä½ç½®æ— å…³çš„ $k^{C}_{t,i}$ï¼Œ$k^{R}_{t}$ ä¾ç„¶è¦æ¯æ¬¡å»é‡æ–°è®¡ç®—ã€‚

DeepSeek è¿˜å¯¹ query ä¹Ÿè¿›è¡Œäº†å‹ç¼©ï¼Œæ–¹å¼å’Œå¯¹ key å’Œ value çš„å‹ç¼©ç›¸ä¼¼ï¼Œä¸»è¦æ˜¯ç”¨äºé™ä½è®­ç»ƒæ—¶çš„å†…å­˜æ¶ˆè€—ã€‚

æ€»ç»“ä¸‹ï¼šå’Œ MHA å¯¹æ¯”ï¼Œ kv cahce ä¿å­˜çš„æ˜¯ $c_t$ è€Œä¸æ˜¯ $k_t$ å’Œ $v_t$ï¼Œå ç”¨å†…å­˜æ›´å°ï¼Œä½†å› ä¸ºå³ä½¿ cache å‘½ä¸­åä¹Ÿéœ€è¦åšé¢å¤–çš„è§£å‹æ“ä½œï¼Œæ€§èƒ½ä¸å¦‚ MHAã€‚

## DeepSeekMoE

åˆ†ä¸º Shared Expert(å¸¸é©») å’Œ Router Expert(å…±äº«)

Router Expert ä¼šè¢«åˆ†ä¸ºå‡ ç»„ï¼Œé€šè¿‡ Router è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œå°†é—®é¢˜åˆ†é…åˆ°åˆé€‚çš„ç»„ä¸­ã€‚è¿™æ˜¯ä¸ºäº†ä½¿ç”¨å¤šèŠ‚ç‚¹è®­ç»ƒæ˜¯é¿å…é€šä¿¡æ¶ˆè€—ï¼Œä¸€èˆ¬ä¸€ä¸ªèŠ‚ç‚¹å­˜æ”¾ä¸€ç»„ä¸“å®¶ï¼ŒåŒä¸€ä¸ªé—®é¢˜æ”¾åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šå¤„ç†ï¼Œé¿å…äº†å¤šèŠ‚ç‚¹é—´çš„é€šä¿¡ã€‚

å¤šèŠ‚ç‚¹é—´çš„å‰å‘å’Œåå‘ä¼ æ’­ï¼ˆpipeline parallel æµæ°´çº¿å¹¶è¡Œï¼‰ï¼š

![alt text](/assets/img/2025-02-03-deepseek/v2-20bf8bdded50d48b114381783a43de76_b.webp)

> æ•°æ®å°±åƒæµæ°´çº¿ä¸€æ ·åœ¨ä¸åŒèŠ‚ç‚¹é—´é€šè¿‡ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¤„ç†å®Œä¸€ä¸ªæ•°æ®å°±å¯ä»¥ç«‹å³å¤„ç†ä¸‹ä¸€ä¸ªæ•°æ®ï¼Œå°±åƒå·¥å‚é‡Œçš„æµæ°´çº¿ä¸€æ ·ï¼Œæ¯é“å·¥åºéƒ½é¥±å’Œè¿è½¬ã€‚

å¤šèŠ‚ç‚¹é—´åŒ batch åå‘ä¼ æ’­æ—¶çš„æ¢¯åº¦æ•´åˆï¼ˆData parallel æ•°æ®å¹¶è¡Œï¼‰ï¼š

![alt text](/assets/img/2025-02-03-deepseek/parallel.png)

## Multi-Token Prediction

![alt text](/assets/img/2025-02-03-deepseek/image.png)

Token Prediction çš„æ„å›¾æ˜¯é€šè¿‡å½“å‰ token é¢„æµ‹ä¸‹ä¸€ä¸ª(ç»„) tokenï¼Œå›¾ä¸­æœ€å·¦è¾¹è¾“å…¥ä¸º $t_1$ åˆ° $t_4$ ï¼Œå‚è€ƒçš„ç»“æœä¸º $t_2$ åˆ° $t_5$ï¼Œä¹Ÿå°±æ˜¯ç”¨ $t_1$ é¢„æµ‹ $t_2$ ï¼Œä»¥æ­¤ç±»æ¨ã€‚ä½†ä»…æœ‰æœ€å·¦è¾¹éƒ¨åˆ†æ— æ³•åšåˆ°è®© $t_1$ é¢„æµ‹ $t_3$ï¼Œæ¢å¥è¯è¯´ï¼Œ$t_1$ æ— æ³•ä¸ºé¢„æµ‹ $t_3$ åšå‡ºè´¡çŒ®ã€‚äºæ˜¯æ·»åŠ äº†åé¢å‡ ä¸ªå±‚ï¼Œè¿™äº›å±‚éƒ½æ˜¯ç”¨å‰ä¸€ä¸ªå±‚çš„è¾“å‡ºä½œä¸ºè¾“å…¥ï¼Œæ‰€ä»¥ $t_1$ çš„ä¿¡æ¯è¢«ä¸æ–­ä¼ é€’ï¼Œæ¯ä¸ª Cross-Entropy Loss éƒ½ä¼šè¢«ç”¨äºæ”¹è¿›æœ€å·¦è¾¹çš„ä¸»æ¨¡å‹çš„æƒé‡ã€‚

## ä¸“å®¶è´Ÿè½½å‡è¡¡

è®­ç»ƒè¿‡ç¨‹è®°å½•æ¯ä¸ª Router Expert çš„è´Ÿè½½ç‡ï¼Œä»…æ¿€æ´»è´Ÿè½½ç‡è¾ƒä½ä¸”ä¸é—®é¢˜è¾ƒç›¸å…³çš„ä¸“å®¶ã€‚

## å¼ºåŒ–å­¦ä¹ 

### Reward Model

ä½¿ç”¨ DeepSeek v3 çš„ä¸€ä¸ªæ£€æŸ¥ç‚¹å¼€å§‹è®­ç»ƒä¸“ç”¨çš„ Reward Model ï¼Œç”¨æ¥ç»™ä¸»æ¨¡å‹è¿›è¡Œå¼ºåŒ–è®­ç»ƒã€‚è¯¥æ¨¡å‹è®­ç»ƒæ—¶ä¸ä»…åŒ…å« reward ç»“æœè¿˜åŠ å…¥äº†å¾—åˆ° reward ç»“æœçš„ chain-of-thought(æ€ç»´é“¾)ã€‚

#### Rule-Based RM

æ•°å­¦ã€ä»£ç ç­‰èƒ½ä½¿ç”¨æ˜ç¡®è§„åˆ™éªŒè¯çš„é—®é¢˜ä½¿ç”¨è¯¥ RMã€‚

æ¯”å¦‚ä»£ç å¯ä»¥ä½¿ç”¨ç¼–è¯‘å™¨ç¼–è¯‘åè¿è¡Œè¾“å‡ºç»“æœ

#### Model-Based RM

è‡ªç”±å½¢å¼ä½†æœ‰æ˜ç¡®ç­”æ¡ˆçš„ï¼Œä½¿ç”¨è¯¥ RM åŒ¹é…ç­”æ¡ˆã€‚

æ²¡æœ‰æ˜ç¡®ç­”æ¡ˆçš„(å¦‚åˆ›æ„å†™ä½œ)ï¼ŒRM æ ¹æ®è¾“å…¥çš„é—®é¢˜å’Œç»“æœç»™äºˆåé¦ˆã€‚

> agent å°±æ˜¯æ¨¡æ‹Ÿäººç±»è§£å†³ç°å®é—®é¢˜çš„æ–¹å¼æ‰§è¡Œå¯¹åº”æ­¥éª¤è§£å†³é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¹Ÿè¦èƒ½æ‹†åˆ†é—®é¢˜ã€è¿ç”¨å·¥å…·ã€æŸ¥æ‰¾èµ„æ–™ã€è¿›è¡Œå†³ç­–ç­‰

## å‚è€ƒ

- [ã€æ·±åº¦å­¦ä¹ ã€‘ã€åˆ†å¸ƒå¼è®­ç»ƒã€‘ä¸€æ–‡æ‹é¡ºåƒäº¿æ¨¡å‹è®­ç»ƒæŠ€æœ¯ï¼šæµæ°´çº¿å¹¶è¡Œã€å¼ é‡å¹¶è¡Œå’Œ 3D å¹¶è¡Œ](https://zhuanlan.zhihu.com/p/617087561)
- [EZ.Encoder Academy youtube](https://www.youtube.com/@ez.encoder.academy)
- [Deepseek v3 æŠ€æœ¯æŠ¥å‘Šä¸‡å­—ç¡¬æ ¸è§£è¯»](https://zhuanlan.zhihu.com/p/16323685381)
- [Attention Is All You Need](https://arxiv.org/abs/1706.03762)
- [DeepSeek-V2: A Strong, Economical, and Efficient Mixture-of-Experts Language Model](https://arxiv.org/abs/2405.04434)
- [DeepSeek-V3](https://github.com/deepseek-ai/DeepSeek-V3)
