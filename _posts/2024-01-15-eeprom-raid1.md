---
title: "嵌入式存储方案"
author: Jinkai
date: 2024-01-15 08:00:00 +0800
published: false
categories: [设计]
tags: [eeprom]
---

## 整体架构

目标：实现一片可靠的存储区域，支持事务(原子写入、掉电一致性)和备份(错误恢复)。

需要两片大小相同的区域，支持页写入和页读取，可以为 eeprom 或 实现了 FTL 的 flash。另外还需要一片区域用于存放日志信息:

|      存储区 1      |      存储区 2      |  日志区   |
| :----------------: | :----------------: | :-------: |
| 512pages X 64Bytes | 512pages X 64Bytes | 4096Bytes |

以上例子中实际可用的应用数据存储区为存储区 1 的大小，存储区 2 的存在同时提供了临时数据保存和备份功能。

## 日志结构

日志由多条记录组成，新记录在上一条记录后追加写入：

- 单条记录：

  | 页号 1 | 页号 2 | 新标志<br>(新 CRC) | 新数据临时区域指针<br>(可选) | 结束符 |
  | :----: | :----: | :----------------: | :--------------------------: | :----: |
  |   2    |   2    |         2          |              2               |   2    |

  - 结束符：用于判断记录是否完整，以及分割不同记录
  - 新数据临时区域指针：指向用于单事务多次写入时存放临时数据的区域，可以为内存或持久性存储。
  - 操作单元：由页号+新标志组成，一条记录可包含多个操作单元
    - 页号：对应逻辑页的编号
    - 新标志：(可选，仅最后一页强制)判断是否为新数据，分两种方式， CRC 或指定特征，当 CRC 相同(碰撞)时需要启用指定特征
      - CRC：为了防止数据异常时 CRC 碰撞，此处可以考虑使用 CRC32，但需要考虑性能，因为这可能需要重新计算。
      - 指定特征：只要能识别新数据就行，可以使用**偏移+差异值**的方式标识新数据

## 写入流程

### 事务单次写入

直接将完整记录写入，然后写入数据，分为两步：

1. 每个逻辑页都对应多份数据页，除了事务最后一页外每个逻辑页都写入一份新数据页(同一区域)，保证每个逻辑页对应有至少一份新数据页和至少一份旧数据页。
2. 为事务最后一页写入一份新数据页（和第一步相同区域）
3. 为在其他区域的数据页重复相同的 1,2 操作，直到新数据全部写入

### 事务多次写入

1. 方案一：多次转单次
   每次写入时，将数据页写入临时区域，将对应操作单元(包括页号、旧标志、临时区域指针)写入记录中，直到事务全部调用完成，为记录写入 END 标记。然后按照单次写入相同的方式将临时区域内数据写入正常数据区。

2. 方案二：
   每次写入时，先将操作单元写入记录，然后写入新数据，直到事务全部调用完成，为记录写入 END 标记。但上电启动时若无 END 标记则需要恢复所有页到旧数据。

## 上电恢复流程

![上电恢复流程](/assets/img/2024-01-15-eeprom-raid1/上电恢复流程.png)

## 为何无需检查点(包含 COMMIT)？

事务原来需要一个 COMMIT 作为执行成功记录(或是检查点用于记录已经执行的步骤，便于异常时恢复)，但本方案可以使用启动时对事务中的每个页的校验来判断当前执行到的阶段，而无需 COMMIT。代价就是每次启动都需要对最新记录进行完整校验。
