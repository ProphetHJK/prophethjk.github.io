<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.3.0" /><meta property="og:title" content="C++实现的DAO(数据访问对象模式)" /><meta name="author" content="Jinkai" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="本文将会介绍如何使用 C++实现设计模式中的 DAO(数据访问对象模式)" /><meta property="og:description" content="本文将会介绍如何使用 C++实现设计模式中的 DAO(数据访问对象模式)" /><link rel="canonical" href="https://hjk.life/posts/cpp-dao/" /><meta property="og:url" content="https://hjk.life/posts/cpp-dao/" /><meta property="og:site_name" content="普通人" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-03-08T09:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="C++实现的DAO(数据访问对象模式)" /><meta name="twitter:site" content="@" /><meta name="twitter:creator" content="@Jinkai" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Jinkai"},"dateModified":"2022-03-09T09:12:26+08:00","datePublished":"2022-03-08T09:00:00+08:00","description":"本文将会介绍如何使用 C++实现设计模式中的 DAO(数据访问对象模式)","headline":"C++实现的DAO(数据访问对象模式)","mainEntityOfPage":{"@type":"WebPage","@id":"https://hjk.life/posts/cpp-dao/"},"url":"https://hjk.life/posts/cpp-dao/"}</script><title>C++实现的DAO(数据访问对象模式) | 普通人</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="普通人"><meta name="application-name" content="普通人"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/favicons/Humanity.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">普通人</a></div><div class="site-subtitle font-italic">潜龙勿用</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/prophethjk" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['prophethjk','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>C++实现的DAO(数据访问对象模式)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>C++实现的DAO(数据访问对象模式)</h1><div class="post-meta text-muted"><div> 作者 <em> <a href="https://github.com/prophethjk">Jinkai</a> </em></div><div class="d-flex"><div> <span> 发表于 <em class="timeago" data-ts="1646701200" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-03-08 </em> </span> <span> 更新于 <em class="timeago" data-ts="1646788346" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-03-09 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="5386 字"> <em>29 分钟</em>阅读</span></div></div></div><div class="post-content"><p>本文将会介绍如何使用 C++实现设计模式中的 DAO(数据访问对象模式)</p><h2 id="dao-介绍"><span class="mr-2">DAO 介绍</span><a href="#dao-介绍" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="什么是-dao"><span class="mr-2">什么是 DAO</span><a href="#什么是-dao" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>在计算机软件中，<code class="language-plaintext highlighter-rouge">数据访问对象</code>（data access object，DAO）是为某种类型的数据库或其他持久性机制提供一个<code class="language-plaintext highlighter-rouge">抽象接口</code>的<code class="language-plaintext highlighter-rouge">对象</code>。通过<code class="language-plaintext highlighter-rouge">映射</code>应用程序对<code class="language-plaintext highlighter-rouge">持久层</code>的调用，DAO 提供一些特定的数据操作，而<code class="language-plaintext highlighter-rouge">无需暴露数据库细节</code>。这种隔离支持<code class="language-plaintext highlighter-rouge">单一功能原则</code>。</p><p>数据访问对象模式（Data Access Object Pattern）或 DAO 模式用于把低级的数据访问 API 或操作从高级的业务服务中分离出来。</p><p>以下是数据访问对象模式的参与者:</p><ul><li><code class="language-plaintext highlighter-rouge">数据访问对象接口（Data Access Object Interface）</code> - 该接口定义了在一个模型对象上要执行的标准操作。<li><code class="language-plaintext highlighter-rouge">数据访问对象实体类（Data Access Object concrete class）</code> - 该类实现了上述的接口。该类负责从数据源获取数据，数据源可以是数据库，也可以是 xml，或者是其他的存储机制。<li><code class="language-plaintext highlighter-rouge">模型对象/数值对象（Model Object/Value Object, VO）</code> - 该对象是简单的 POJO，包含了 get/set 方法来存储通过使用 DAO 类检索到的数据。</ul><p><img data-src="/assets/img/2022-03-08-cpp-dao/DAO1.png" alt="DAO1" data-proofer-ignore></p><p><img data-src="/assets/img/2022-03-08-cpp-dao/dao_pattern_uml_diagram.jpg" alt="dao_pattern_uml_diagram" data-proofer-ignore></p><h3 id="dao-的优势"><span class="mr-2">DAO 的优势</span><a href="#dao-的优势" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li><p><code class="language-plaintext highlighter-rouge">数据存储逻辑的分离</code>：一方面避免业务代码中混杂的数据库操作代码，另一方面，数据访问接口与数据访问实现相分离，这样精通数据库的人可以根据接口专注于数据库访问的最优化实现，而精通业务的人可以专注于业务逻辑编码。</p><li><p><code class="language-plaintext highlighter-rouge">数据访问底层实现的分离</code>：DAO 模式将数据访问分为抽象层和实现层，分离了数据使用和数据访问的底层实现细节。这样可以在保持上层结构不变的情况下，通过更改底层实现来修改数据访问的机制，比如只要通过修改数据访问层实现，我们就可以部署在不同数据库平台上。</p><li><p><code class="language-plaintext highlighter-rouge">资源管理和调度的分离</code>：数据访问逻辑从业务逻辑中脱离开来，使数据访问层实现统一的资源调度，通过数据库连接池和各种缓存机制的使用，可以保持上层系统不变的情况下来提高系统性能。</p><li><p><code class="language-plaintext highlighter-rouge">数据抽象</code>：通过对底层数据的封装，开发人员可以使用面向对象思想对数据进行操作。比如通过调用方法获取数据比通过 SQL 语句访问数据库获取数据，在代码上更易于理解，清晰，对日后维护带来便利。</p></ol><h3 id="dao-的劣势"><span class="mr-2">DAO 的劣势</span><a href="#dao-的劣势" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><ol><li><p><code class="language-plaintext highlighter-rouge">抽象泄漏</code>：尽管抽象层可以屏蔽底层细节，让开发者可以专注于高层次的领域相关的知识与技能，但一旦底层出了问题，开发者不可避免的需要了解底层细节来帮助分析问题。所以抽象机制虽然节省了工作的时间，不过学习的时间是省不掉的。</p><li><p><code class="language-plaintext highlighter-rouge">代码重复</code>：将 DAO 作为常规对象的抽象会隐藏每个数据库访问的高成本，并且可能强迫开发人员触发多个数据库查询来检索普通 SQL 查询中一次就可取回的信息。如果一个应用程序需要多个 DAO，人们可能发现自己对每个 DAO 重复基本上相同的创建、读取、更新和删除代码</p><li><p><code class="language-plaintext highlighter-rouge">抽象反转(Abstraction inversion)</code>：抽象反转是一种反模式，当构造的用户需要在其中实现但未由其接口公开的函数时， 会产生这种反模式。结果是用户在接口方面重新实现所需的功能，而接口又使用相同的功能的内部实现。这可能会导致在较高级别的特征中实现较低级别的特征</p></ol><h3 id="在什么情况下使用-dao"><span class="mr-2">在什么情况下使用 DAO</span><a href="#在什么情况下使用-dao" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>DAO 最适用于单系统应用程序或小范围本地分布使用</p><h3 id="dao-与当前业务的契合度"><span class="mr-2">DAO 与当前业务的契合度</span><a href="#dao-与当前业务的契合度" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>集中器作为采集设备，需要频繁与数据库进行交互，用于存储和读取数据、参数等，当前集中器业务代码中包含大量直接调用 sqlite3 api 访问数据库的操作。</p><ul><li>一方面让代码的维护更加复杂，每一位开发者都不得不具备专业的数据库相关知识，浪费大量时间精力<li>另一方面缺乏错误处理机制让数据库写入冲突更加频繁，程序稳定性大大降低</ul><p>而使用 DAO 设计模式可以解决上述两个问题，让代码维护分工更加明确，专人专职，错误处理绝大部分由底层完成，降低写入冲突</p><p>集中器程序使用C++作为主要开发语言，作为支持面向对象的语言可以实现DAO。</p><h2 id="dao-的实现"><span class="mr-2">DAO 的实现</span><a href="#dao-的实现" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>2.0 平台将数据访问操作重新设计，使用设计模式中的 DAO(data access object)设计模式，为每个数据项设计访问接口，将原数据库访问操作封装为 DAO 数据访问层和服务接口，其他业务类需要获取或写入数据时直接调用服务接口，传递访问参数即可。数据库操作对应用程序是不可见的，业务层无需关心数据如何存储，存储在什么地方。</p><p><img data-src="/assets/img/2022-03-08-cpp-dao/dao2.png" alt="DAO2" data-proofer-ignore></p><p>Service 服务层实现了对于业务层开放的统一操作接口，对于一个接口的调用服务层会将多个原子性的 DAO 操作组合成一个完整的业务逻辑。服务层同时也实现了对数据记录的缓存，对于读取操作直接访问缓存，无需访问数据库，降低了 IO 操作，提升数据访问速度。</p><p>DAO 层实现了对数据层访问的封装，包括执行增、删、改、查等原子性操作，数据层可以使用 sqlite3 或其他数据库，不会对服务层和业务层产生影响，使用 DAO 层可以使后续对数据库结构的修改和扩展更为便捷。同时可以单独对 DAO 层进行优化用于提升访问性能，提升可维护性。</p><p>封装库同时完成数据库访问的冲突管理及持久化管理，避免了因多线程同时访问数据库产生的冲突，分层设计提高了程序的可扩展性，同时降低直接访问数据库的频率。整体提高软件稳定性、可维护性、可扩展性和可移植性。</p><h3 id="设计细节"><span class="mr-2">设计细节</span><a href="#设计细节" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><pre><code class="language-plantuml!">scale 2
title config类型数据管理接口类图

note left of ConfItem
    实体类(VO)：
    映射数据库记录
end note
class ConfItem {
    -int id
    -string key
    -string value
    -string remark
    +ConfItem()
    +ConfItem(Json::Value item_json)
    +ConfItem(int id, string key, string value, string remark)
    +~ConfItem()
    +{static} int json2item(Json::Value item_json, ConfItem* conf_item)
    +{static} int item2json(ConfItem conf_item, Json::Value* item_json)
    +int getValueInt()
    +string getValueString()
    +string getKey()
    +string getRemark()
    +int getId()
    +int setValueInt(int value_int)
    +int setValueString(string value_string)
    +int setKey(string key)
    +int setRemark(string remark)
    +int setId(int id)
}

note bottom of DBUtils
    数据库底层接口类(单例模式)：
    操作sqlite3数据库的接口，
    同原DB和DB_Data类
end note
class DBUtils {
    +{static} DBUtils* instance()
    +int executeSQL(string sql)
    +SQLQuery execQuery(const string &amp;szSQL)
    +Binder buildBinder(const string &amp;szSQL)
    -sqlite3_stmt* compile(const char* szSQL)
    -void checkDB(int iRet)
}

note top of ConfBaseDAO
    DAO接口类(DAO)
    用于定义数据库的原子化操作,增删查改：
end note
note left of ConfBaseDAO::findByKey
    ConfItem中的key也为唯一键，
    可以作为查询依据
end note
abstract class ConfBaseDAO
{
    +{abstract} int add(ConfItem&amp; conf_item)
    +{abstract} int update(ConfItem&amp; conf_item)
    +{abstract} int updateValue(ConfItem&amp; conf_item)
    +{abstract} int del(int id)
    +{abstract} int findById(ConfItem&amp; conf_item)
    +{abstract} int findByKey(ConfItem&amp; conf_item)
    +{abstract} int findAll(std::vector&lt;ConfItem&gt;&amp; conf_item_list)
    +{abstract} int getAllConunt()
}

note top of ConfBaseDAOlmpl
    DAO基于sqlite3实现类(Impl)：
    针对不同数据库工具给出DAO接口定义方法
    的具体实现，此处为sqlite3实现
    初始化时配置对应的数据库连接和表名，
    可以使用事务保证原子性
end note
class ConfBaseDAOlmpl {
    DBUtils* db;
    std::string table_name;
}

note top of ConfBaseService
    服务类(service)：
    DAO的封装，
    扩展业务实现，
    便于业务处理函数调用
end note


note left of ConfBaseService::key_filter_set
    get自动模式下判断是否从数据库中获取
end note
note left of ConfBaseService::conf_base_dao
    指向其实现类ConfBaseDAOlmpl的对象
end note
note left of ConfBaseService::jsonApi
    jsonApi接口(待实现)
    可以通过json方式操作数据库
end note
note left of ConfBaseService::updateValueByKey
    通过key更新value
end note
note left of ConfBaseService::getValueByKey
    通过key获取value,
    mode表示从数据库获取还是内存获取
end note
class ConfBaseService {
    #std::set&lt;std::string&gt; key_filter_set
    #std::map&lt;std::string, ConfItem&gt; conf_item_list
    #ConfBaseDAO* conf_base_dao
    #int getConfItemByKey(ConfItem&amp; conf_item, const std::string&amp; key, int getmode)
    +ConfBaseService()
    +ConfBaseService(DB* db, const std::string&amp; table_name)
    +ConfBaseService(const std::string&amp; table_name)
    +~ConfBaseService()
    +int jsonApi(Json::Value* root)
    +int add(const std::string&amp; key, const std::string&amp; value, const std::string&amp; remark)
    +int updateValueByKey(const std::string&amp; value,const std::string&amp; key)
    +int updateValueByKey(int value,const std::string&amp; key)
    +int getValueByKey(std::string&amp; value, const std::string&amp; key, int getmode = 0)
    +int getValueByKey(int&amp; value, const std::string&amp; key, int getmode = 0)
    +int deleteByKey(const std::string&amp; key)
    +int syncAll()
    +int getSize()
}

note top of DCConfService
    dc_conf表的服务类(单例模式)：
    由于数据库中部分表使用相同的结构，
    可以让这些服务类继承同一个ConfBaseService
end note
class DCConfService {
    +{static} DCConfService* instance()
    +DCConfService()
    +~DCConfService()
}
note top of DCConfMainService
    dc_conf_main表的服务类：
end note
class DCConfMainService {
    +{static} DCConfMainService* instance()
    +DCConfMainService()
    +~DCConfMainService()
}
note top of DCStatusService
    dc_status表的服务类：
end note
class DCStatusService {
    +{static} DCStatusService* instance()
    +DCStatusService()
    +~DCStatusService()
}

ConfBaseDAOlmpl ..|&gt; ConfBaseDAO :"实现(多态)"
ConfBaseDAOlmpl --&gt; DBUtils :"关联"
ConfBaseDAO ..&gt; ConfItem :"依赖"
ConfBaseService --&gt; ConfBaseDAO :"关联"
ConfBaseService --&gt; ConfItem :"关联"
DCConfService --|&gt; ConfBaseService :"继承"
DCConfMainService --|&gt; ConfBaseService :"继承"
DCStatusService --|&gt; ConfBaseService :"继承"
</code></pre><h3 id="部分代码示例"><span class="mr-2">部分代码示例</span><a href="#部分代码示例" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><h4 id="数值对象vo"><span class="mr-2">数值对象,VO</span><a href="#数值对象vo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
</pre><td class="rouge-code"><pre><span class="cm">/**
 * @file conf_item.h
 * @author huangjinkai
 * @brief 声明ConfItem实体类（VO），映射数据库记录
 * @version 1.0
 * @date 2021-12-03
 *
 * @copyright Copyright (c) 2021
 *
 */</span>

<span class="cp">#ifndef _CONF_ITEM_H
#define _CONF_ITEM_H
</span>
<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
#include</span> <span class="cpf">"json/json.h"</span><span class="cp">
</span>
<span class="cm">/**
 * @brief ConfItem实体类（VO），映射数据库记录
 *
 */</span>
<span class="k">class</span> <span class="nc">ConfItem</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="c1">/// 对应键id，主键</span>
    <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
    <span class="c1">/// 对应键key，唯一键</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">key</span><span class="p">;</span>
    <span class="c1">/// 对应键value</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">value</span><span class="p">;</span>
    <span class="c1">/// 对应键remark</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">remark</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="cm">/**
     * @brief 默认构造函数，为成员变量赋默认初值
     *
     */</span>
    <span class="n">ConfItem</span><span class="p">();</span>
    <span class="cm">/**
     * @brief 构造函数，使用json数据为成员变量赋初值
     *
     * @param item_json
     */</span>
    <span class="n">ConfItem</span><span class="p">(</span><span class="n">Json</span><span class="o">::</span><span class="n">Value</span> <span class="n">item_json</span><span class="p">);</span>
    <span class="cm">/**
     * @brief 构造函数，使用参数为成员变量赋初值
     *
     * @param id
     * @param key
     * @param value
     * @param remark
     */</span>
    <span class="n">ConfItem</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">key</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">value</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">remark</span><span class="p">);</span>
    <span class="cm">/**
     * @brief 析构函数
     *
     */</span>
    <span class="o">~</span><span class="n">ConfItem</span><span class="p">();</span>
    <span class="cm">/**
     * @brief json对象转ConfItem对象
     *
     * @param item_json
     * @param conf_item
     * @return int 是否成功
     * @retval 0 执行成功
     * @retval other 执行失败
     */</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">json2item</span><span class="p">(</span><span class="n">Json</span><span class="o">::</span><span class="n">Value</span> <span class="n">item_json</span><span class="p">,</span> <span class="n">ConfItem</span><span class="o">&amp;</span> <span class="n">conf_item</span><span class="p">);</span>
    <span class="cm">/**
     * @brief ConfItem对象转json对象
     *
     * @param conf_item
     * @param item_json
     * @return int 是否成功
     * @retval 0 执行成功
     * @retval other 执行失败
     */</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">item2json</span><span class="p">(</span><span class="n">ConfItem</span> <span class="n">conf_item</span><span class="p">,</span> <span class="n">Json</span><span class="o">::</span><span class="n">Value</span><span class="o">&amp;</span> <span class="n">item_json</span><span class="p">);</span>
    <span class="cm">/**
     * @brief Get the Value Int object
     *
     * @return int
     */</span>
    <span class="kt">int</span> <span class="n">getValueInt</span><span class="p">();</span>
    <span class="cm">/**
     * @brief Get the Value String object
     *
     * @return std::string
     */</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">getValueString</span><span class="p">();</span>
    <span class="cm">/**
     * @brief Get the Key object
     *
     * @return std::string key
     */</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">getKey</span><span class="p">();</span>
    <span class="cm">/**
     * @brief Get the Remark object
     *
     * @return std::string remark
     */</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">getRemark</span><span class="p">();</span>
    <span class="cm">/**
     * @brief Get the Id object
     *
     * @return int id
     */</span>
    <span class="kt">int</span> <span class="n">getId</span><span class="p">();</span>
    <span class="cm">/**
     * @brief Set the Value Int object
     *
     * @param value_int
     * @return int
     */</span>
    <span class="kt">int</span> <span class="n">setValueInt</span><span class="p">(</span><span class="kt">int</span> <span class="n">value_int</span><span class="p">);</span>
    <span class="cm">/**
     * @brief Set the Value String object
     *
     * @param value_string
     * @return int 是否成功
     * @retval 0 执行成功
     * @retval other 执行失败
     */</span>
    <span class="kt">int</span> <span class="n">setValueString</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">value_string</span><span class="p">);</span>
    <span class="cm">/**
     * @brief Set the Key object
     *
     * @param key
     * @return int 是否成功
     * @retval 0 执行成功
     * @retval other 执行失败
     */</span>
    <span class="kt">int</span> <span class="n">setKey</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">key</span><span class="p">);</span>
    <span class="cm">/**
     * @brief Set the Remark object
     *
     * @param remark
     * @return int 是否成功
     * @retval 0 执行成功
     * @retval other 执行失败
     */</span>
    <span class="kt">int</span> <span class="n">setRemark</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">remark</span><span class="p">);</span>
    <span class="cm">/**
     * @brief Set the Id object
     *
     * @param id
     * @return int 是否成功
     * @retval 0 执行成功
     * @retval other 执行失败
     */</span>
    <span class="kt">int</span> <span class="n">setId</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>
<span class="p">};</span>

<span class="cp">#endif // _CONF_ITEM_H
</span></pre></table></code></div></div><h4 id="dao接口"><span class="mr-2">DAO接口</span><a href="#dao接口" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
</pre><td class="rouge-code"><pre><span class="cm">/**
 * @file conf_base_dao.h
 * @author huangjinkai
 * @brief
 * @version 1.0
 * @date 2021-12-03
 *
 * @copyright Copyright (c) 2021
 *
 */</span>
<span class="cp">#ifndef _CONF_BASE_DAO_H
#define _CONF_BASE_DAO_H
</span>
<span class="cp">#include</span> <span class="cpf">"database/conf_item.h"</span><span class="cp">
#include</span> <span class="cpf">"database/database.h"</span><span class="cp">
#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span>
<span class="cm">/**
 * @brief DAO接口类
 * 虚类，用于定义数据库的原子化操作增删改查
 *
 */</span>
<span class="k">class</span> <span class="nc">ConfBaseDAO</span>
<span class="p">{</span>
<span class="nl">protected:</span>

<span class="nl">public:</span>
    <span class="cm">/**
     * @brief Construct a new ConfBaseDAO object
     *
     */</span>
    <span class="n">ConfBaseDAO</span><span class="p">(){};</span>
    <span class="cm">/**
     * @brief Destroy the ConfBaseDAO object
     *
     */</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">ConfBaseDAO</span><span class="p">(){};</span>
    <span class="cm">/**
     * @brief 插入一条记录
     *
     * @param conf_item ConfItem对象
     * @return int 是否成功
     * @retval 0 成功
     * @retval -1 失败
     */</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">add</span><span class="p">(</span><span class="n">ConfItem</span><span class="o">&amp;</span> <span class="n">conf_item</span><span class="p">){};</span>
    <span class="cm">/**
     * @brief 通过id更新一条记录
     *
     * @param conf_item ConfItem对象
     * @return int 是否成功
     * @retval 0 成功
     * @retval -1 失败
     */</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">update</span><span class="p">(</span><span class="n">ConfItem</span><span class="o">&amp;</span> <span class="n">conf_item</span><span class="p">){};</span>
    <span class="cm">/**
     * @brief 通过key更新一条记录的value值
     *
     * @param conf_item ConfItem对象
     * @return int 是否成功
     * @retval 0 成功
     * @retval -1 失败
     */</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">updateValue</span><span class="p">(</span><span class="n">ConfItem</span><span class="o">&amp;</span> <span class="n">conf_item</span><span class="p">){};</span>
    <span class="cm">/**
     * @brief 通过id删除一条记录
     *
     * @param id 记录的id键值
     * @return int 是否成功
     * @retval 0 成功
     * @retval -1 失败
     */</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">del</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">){};</span>
    <span class="cm">/**
     * @brief 通过id查找一条记录
     *
     * @param conf_item ConfItem对象，作为输入参数与返回值，包含待查找的id
     * @return int 是否成功
     * @retval 0 成功
     * @retval -1 失败
     */</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">findById</span><span class="p">(</span><span class="n">ConfItem</span><span class="o">&amp;</span> <span class="n">conf_item</span><span class="p">){};</span>
    <span class="cm">/**
     * @brief 通过key查找一条记录
     *
     * @param conf_item ConfItem对象，作为输入参数与返回值，包含待查找的key
     * @return int 是否成功
     * @retval 0 成功
     * @retval -1 失败
     */</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">findByKey</span><span class="p">(</span><span class="n">ConfItem</span><span class="o">&amp;</span> <span class="n">conf_item</span><span class="p">){};</span>
    <span class="cm">/**
     * @brief 查找所有的记录
     *
     * @param conf_item_list  ConfItem数组，作为返回值
     * @return int 是否成功
     * @retval 0 成功
     * @retval -1 失败
     */</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">findAll</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ConfItem</span><span class="o">&gt;&amp;</span> <span class="n">conf_item_list</span><span class="p">){};</span>
    <span class="cm">/**
     * @brief 返回记录总数
     *
     * @return int 记录总数
     */</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">getAllConunt</span><span class="p">(){};</span>
    <span class="cm">/**
     * @brief 清空所有记录
     * 
     * @return int
     * @retval 0 成功
     * @retval -1 失败
     */</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">(){};</span>
<span class="p">};</span>

<span class="cp">#endif //_CONF_BASE_DAO_H
</span></pre></table></code></div></div><h4 id="dao实现-impl"><span class="mr-2">DAO实现, impl</span><a href="#dao实现-impl" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="cm">/**
 * @file conf_base_dao_impl.h
 * @author huangjinkai
 * @brief 
 * @version 1.0
 * @date 2021-12-03
 * 
 * @copyright Copyright (c) 2021
 * 
 */</span>
<span class="cp">#ifndef _CONF_BASE_DAO_IMPL_H
#define _CONF_BASE_DAO_IMPL_H
</span>
<span class="cp">#include</span> <span class="cpf">"database/conf_base_dao.h"</span><span class="cp">
#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span>
<span class="cm">/**
 * @brief     DAO 实现类(Impl)
 * 继承自ConfBaseDAO，是对ConfBaseDAO的多态实现。针对不同数据库工具给出DAO接口定义方法的具体实现，此处为sqlite3实现
 * 初始化时配置对应的数据库连接和表名，可以使用事务保证原子性
 * 
 */</span>
<span class="k">class</span> <span class="nc">ConfBaseDAOImpl</span><span class="o">:</span> <span class="k">public</span> <span class="n">ConfBaseDAO</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="c1">/// 数据库访问工具实例指针</span>
    <span class="n">DB</span><span class="o">*</span> <span class="n">db</span><span class="p">;</span>
    <span class="c1">/// 数据表名</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">table_name</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="cm">/**
     * @brief Construct a new ConfBaseDAOImpl object
     * 
     */</span>
    <span class="n">ConfBaseDAOImpl</span><span class="p">();</span>
    <span class="cm">/**
     * @brief Construct a new ConfBaseDAOImpl object
     * 
     * @param db 
     * @param table_name 
     */</span>
    <span class="n">ConfBaseDAOImpl</span><span class="p">(</span><span class="n">DB</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">table_name</span><span class="p">);</span>
    <span class="cm">/**
     * @brief Destroy the ConfBaseDAOImpl object
     * 
     */</span>
    <span class="o">~</span><span class="n">ConfBaseDAOImpl</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">add</span><span class="p">(</span><span class="n">ConfItem</span><span class="o">&amp;</span> <span class="n">conf_item</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">update</span><span class="p">(</span><span class="n">ConfItem</span><span class="o">&amp;</span> <span class="n">conf_item</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">updateValue</span><span class="p">(</span><span class="n">ConfItem</span><span class="o">&amp;</span> <span class="n">conf_item</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">del</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">findById</span><span class="p">(</span><span class="n">ConfItem</span><span class="o">&amp;</span> <span class="n">conf_item</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">findByKey</span><span class="p">(</span><span class="n">ConfItem</span><span class="o">&amp;</span> <span class="n">conf_item</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">findAll</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ConfItem</span><span class="o">&gt;&amp;</span> <span class="n">conf_item_list</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">getAllConunt</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">clear</span><span class="p">();</span>
<span class="p">};</span>

<span class="cp">#endif //_CONF_BASE_DAO_IMPL_H
</span></pre></table></code></div></div><h4 id="服务类service"><span class="mr-2">服务类，service</span><a href="#服务类service" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
</pre><td class="rouge-code"><pre><span class="cm">/**
 * @file conf_base_service.h
 * @author huangjinkai
 * @brief
 * @version 1.0
 * @date 2021-12-03
 *
 * @copyright Copyright (c) 2021
 *
 */</span>

<span class="cp">#ifndef _CONF_BASE_SERVICE_H
#define _CONF_BASE_SERVICE_H
</span>
<span class="cp">#include</span> <span class="cpf">"conf_base_dao.h"</span><span class="cp">
#include</span> <span class="cpf">"conf_base_dao_impl.h"</span><span class="cp">
#include</span> <span class="cpf">&lt;map&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;set&gt;</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">ConfBaseService</span>
<span class="p">{</span>
<span class="nl">protected:</span>
    <span class="c1">/// key过滤器，get自动模式下判断是否从数据库中获取记录</span>
    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">key_filter_set</span><span class="p">;</span>
    <span class="c1">/// ConfItem对象和key的map映射表，在内存中保存数据</span>
    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">ConfItem</span><span class="o">&gt;</span> <span class="n">conf_item_list</span><span class="p">;</span>
    <span class="c1">/// ConfBaseDAO实例对象指针，需要在构造时赋值</span>
    <span class="n">ConfBaseDAO</span><span class="o">*</span> <span class="n">conf_base_dao</span><span class="p">;</span>
    <span class="c1">/// conf_item_list的互斥锁</span>
    <span class="n">pthread_mutex_t</span> <span class="n">conf_item_list_lock</span><span class="p">;</span>
    <span class="cm">/**
     * @brief 通过key获取ConfItem对象
     *
     * @param[out] conf_item
     * @param[in] key
     * @param[in] getmode 获取模式，0：自动，1：从DAO获取，2：从conf_item_list获取
     * @return int 是否成功
     * @retval 0 成功
     * @retval -1 不支持的模式getmode
     * @retval -2 未在conf_item_list中找到
     * @retval other 其他错误
     */</span>
    <span class="kt">int</span> <span class="n">getConfItemByKey</span><span class="p">(</span><span class="n">ConfItem</span><span class="o">&amp;</span> <span class="n">conf_item</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">getmode</span><span class="p">);</span>
<span class="nl">public:</span>
    <span class="cm">/**
     * @brief Construct a new ConfBaseService object
     *
     */</span>
    <span class="n">ConfBaseService</span><span class="p">();</span>

    <span class="cm">/**
     * @brief Construct a new ConfBaseService object
     *
     * @param[in] db 数据库访问工具实例
     * @param[in] table_name 数据表名
     */</span>
    <span class="n">ConfBaseService</span><span class="p">(</span><span class="n">DB</span><span class="o">*</span> <span class="n">db</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">table_name</span><span class="p">);</span>

    <span class="cm">/**
     * @brief Construct a new ConfBaseService object
     *
     * @param[in] table_name 数据表名
     */</span>
    <span class="n">ConfBaseService</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">table_name</span><span class="p">);</span>

    <span class="cm">/**
     * @brief Destroy the ConfBaseService object
     *
     */</span>
    <span class="o">~</span><span class="n">ConfBaseService</span><span class="p">();</span>

    <span class="cm">/**
     * @brief json访问接口
     *
     * @todo 待实现
     * @param root json对象
     * @return int
     */</span>
    <span class="kt">int</span> <span class="n">jsonApi</span><span class="p">(</span><span class="n">Json</span><span class="o">::</span><span class="n">Value</span><span class="o">*</span> <span class="n">root</span><span class="p">);</span>

    <span class="cm">/**
     * @brief 添加记录
     *
     * @param[in] key 参数名
     * @param[in] value 参数值
     * @param[in] remark 参数说明
     * @return int 是否成功
     * @retval 0 成功
     * @retval other 失败
     */</span>
    <span class="kt">int</span> <span class="n">add</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">remark</span><span class="p">);</span>

    <span class="cm">/**
     * @brief 添加记录
     *
     * @param[in] key 参数名
     * @param[in] value 参数值
     * @param[in] remark 参数说明
     * @return int 是否成功
     * @retval 0 成功
     * @retval other 失败
     */</span>
    <span class="kt">int</span> <span class="n">add</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">remark</span><span class="p">);</span>

    <span class="cm">/**
     * @brief 通过key更新string类型value
     *
     * @param[in] value 参数值
     * @param[in] key 参数名
     * @return int 是否成功
     * @retval 0 成功
     * @retval other 失败
     */</span>
    <span class="kt">int</span> <span class="n">updateValueByKey</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">,</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">);</span>

    <span class="cm">/**
     * @brief 通过参数名更新int类型参数值
     *
     * @param[in] value 参数值
     * @param[in] key 参数名
     * @return int 是否成功
     * @retval 0 成功
     * @retval other 失败
     */</span>
    <span class="kt">int</span> <span class="n">updateValueByKey</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">,</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">);</span>

    <span class="cm">/**
     * @brief 通过参数名获取string类型参数值
     *
     * @param[out] value 参数值
     * @param[in] key 参数名
     * @param[in] getmode 获取模式，0：自动，1：从DAO获取，2：从conf_item_list获取
     * @return int 是否成功
     * @retval 0 成功
     * @retval -1 失败
     */</span>
    <span class="kt">int</span> <span class="n">getValueByKey</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">getmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>

    <span class="cm">/**
     * @brief 通过参数名获取int类型参数值
     *
     * @param[out] value 参数值
     * @param[in] key 参数名
     * @param[in] getmode 获取模式，0：自动，1：从DAO获取，2：从conf_item_list获取
     * @return int 是否成功
     * @retval 0 成功
     * @retval -1 失败
     */</span>
    <span class="kt">int</span> <span class="n">getValueByKey</span><span class="p">(</span><span class="kt">int</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">getmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>

    <span class="cm">/**
     * @brief 通过key删除记录
     *
     * @param[in] key 参数名
     * @return int 是否成功
     * @retval 0 成功
     * @retval -1 失败
     */</span>
    <span class="kt">int</span> <span class="n">deleteByKey</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">);</span>

    <span class="cm">/**
     * @brief 同步记录到conf_item_list中
     *
     * @return int 是否成功
     * @retval 0 成功
     * @retval -1 失败
     */</span>
    <span class="kt">int</span> <span class="n">syncAll</span><span class="p">();</span>

    <span class="cm">/**
     * @brief 获取总记录数量
     *
     * @return int 总记录数量
     */</span>
    <span class="kt">int</span> <span class="n">getSize</span><span class="p">();</span>
    <span class="cm">/**
     * @brief 删除所有记录
     *
     * @return int 是否成功
     * @retval 0 成功
     * @retval other 失败
     */</span>
    <span class="kt">int</span> <span class="n">clearAll</span><span class="p">();</span>
<span class="p">};</span>

<span class="cp">#endif //_CONF_BASE_SERVICE_H
</span></pre></table></code></div></div><h4 id="派生实例单例模式"><span class="mr-2">派生实例，单例模式</span><a href="#派生实例单例模式" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><div class="language-cpp highlighter-rouge"><div class="code-header"> <span data-label-text="Cpp"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre><td class="rouge-code"><pre><span class="cm">/**
 * @file dcconf_service.h
 * @author huangjinkai
 * @brief 
 * @version 1.0
 * @date 2021-12-03
 * 
 * @copyright Copyright (c) 2021
 * 
 */</span>

<span class="cp">#ifndef _DCCONF_SERVICE_H
#define _DCCONF_SERVICE_H
</span>
<span class="cp">#include</span> <span class="cpf">"database/conf_base_service.h"</span><span class="cp">
</span>
<span class="k">class</span> <span class="nc">DCConfService</span><span class="o">:</span> <span class="k">public</span> <span class="n">ConfBaseService</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="cm">/**
     * @brief Construct a new DCConfService object
     * 
     */</span>
    <span class="n">DCConfService</span><span class="p">();</span>
    <span class="cm">/**
     * @brief Destroy the DCConfService object
     * 
     */</span>
    <span class="o">~</span><span class="n">DCConfService</span><span class="p">();</span>
    <span class="cm">/**
     * @brief 获取DCConfService实例
     * 
     * @return DCConfService* DCConfService实例指针
     */</span>
    <span class="k">static</span> <span class="n">DCConfService</span><span class="o">*</span> <span class="n">instance</span><span class="p">();</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">DCConfMainService</span><span class="o">:</span> <span class="k">public</span> <span class="n">ConfBaseService</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="cm">/**
     * @brief Construct a new DCConfMainService object
     * 
     */</span>
    <span class="n">DCConfMainService</span><span class="p">();</span>
    <span class="cm">/**
     * @brief Destroy the DCConfMainService object
     * 
     */</span>
    <span class="o">~</span><span class="n">DCConfMainService</span><span class="p">();</span>
    <span class="cm">/**
     * @brief 获取DCConfMainService实例
     * 
     * @return DCConfMainService* DCConfMainService实例指针
     */</span>
    <span class="k">static</span> <span class="n">DCConfMainService</span><span class="o">*</span> <span class="n">instance</span><span class="p">();</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">DCStatusService</span><span class="o">:</span> <span class="k">public</span> <span class="n">ConfBaseService</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="cm">/**
     * @brief Construct a new DCStatusService object
     * 
     */</span>
    <span class="n">DCStatusService</span><span class="p">();</span>
    <span class="cm">/**
     * @brief Destroy the DCStatusService object
     * 
     */</span>
    <span class="o">~</span><span class="n">DCStatusService</span><span class="p">();</span>
    <span class="cm">/**
     * @brief 获取DCStatusService实例
     * 
     * @return DCStatusService* DCStatusService实例指针
     */</span>
    <span class="k">static</span> <span class="n">DCStatusService</span><span class="o">*</span> <span class="n">instance</span><span class="p">();</span>
<span class="p">};</span>

<span class="cp">#endif //_DCCONF_SERVICE_H
</span></pre></table></code></div></div><h2 id="参考"><span class="mr-2">参考</span><a href="#参考" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><a href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%AF%B9%E8%B1%A1">数据访问对象 - 维基百科，自由的百科全书</a><li><a href="https://www.runoob.com/design-pattern/data-access-object-pattern.html">数据访问对象模式 - 菜鸟教程</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E6%8A%80%E6%9C%AF/'>技术</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/c/" class="post-tag no-text-decoration" >C++</a> <a href="/tags/dao/" class="post-tag no-text-decoration" >DAO</a> <a href="/tags/database/" class="post-tag no-text-decoration" >database</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=C++实现的DAO(数据访问对象模式) - 普通人&amp;url=https://hjk.life/posts/cpp-dao/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=C++实现的DAO(数据访问对象模式) - 普通人&amp;u=https://hjk.life/posts/cpp-dao/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://hjk.life/posts/cpp-dao/&amp;text=C++实现的DAO(数据访问对象模式) - 普通人" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="http://service.weibo.com/share/share.php?title=C++实现的DAO(数据访问对象模式) - 普通人&amp;url=https://hjk.life/posts/cpp-dao/" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/quantum-platform-1/">《UML 状态图的实用 C/C++设计》(QP状态机)学习笔记</a><li><a href="/posts/design-patterns-principles/">软件设计模式——七大设计原则</a><li><a href="/posts/const-c/">C语言中的const</a><li><a href="/posts/c-oop/">面向对象编程(OOP)的C语言实现</a><li><a href="/posts/operating-systems-28/">《Operating Systems: Three Easy Pieces》学习笔记(二十八) I/O 设备</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/operating-systems/">Operating Systems</a> <a class="post-tag" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/">操作系统导论</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/dao/">DAO</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/vscode/">vscode</a> <a class="post-tag" href="/tags/shell/">shell</a> <a class="post-tag" href="/tags/5g/">5G</a> <a class="post-tag" href="/tags/btrfs/">btrfs</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/dlms-blue2/"><div class="card-body"> <em class="timeago small" data-ts="1646701200" > 2022-03-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>DLMS/COSEM Blue Book学习笔记</h3><div class="text-muted small"><p> s4.1 基本概念 s4.1.2 Referencing methods logical names (LN referencing):The reference for an attribute is: class_id, value of the logical_name attribute, attribute_index.The reference for a method is...</p></div></div></a></div><div class="card"> <a href="/posts/dlms-green-1/"><div class="card-body"> <em class="timeago small" data-ts="1650330000" > 2022-04-19 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>DLMS Green Book学习笔记</h3><div class="text-muted small"><p> s1 Scope s3 Terms, definitions and abbreviations and symbols s3.1 General DLMS/COSEM definitions s4 Information exchange in DLMS/COSEM s4.1 General s4.2 C...</p></div></div></a></div><div class="card"> <a href="/posts/plantuml-vscode/"><div class="card-body"> <em class="timeago small" data-ts="1628038800" > 2021-08-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>使用PlantUML绘制类图</h3><div class="text-muted small"><p> 本文基于 vscode 的 PlantUML 插件绘制类图。 类的 UML 表示 使用 UML 表示一个类，主要由三部分组成。类名、属性、方法。其中属性和方法的访问修饰符用 - 、# 、+ 表示 private、protected、public。 如图所示，表示A类有一个private属性，protected 构造函数和public方法。 @startuml class A{ ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/containers-edge-cloudnative/" class="btn btn-outline-primary" prompt="上一篇"><p>容器,边缘计算与云原生</p></a> <a href="/posts/dlms-blue2/" class="btn btn-outline-primary" prompt="下一篇"><p>DLMS/COSEM Blue Book学习笔记</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "ProphetHJK/prophethjk.github.io", "data-repo-id": "MDEwOlJlcG9zaXRvcnkzMjk1MjU2NjI=", "data-category": "General", "data-category-id": "DIC_kwDOE6Qpns4CPYgF", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "bottom", "data-lang": "zh-CN", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/prophethjk">Jinkai</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> <a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener">浙ICP备20006745号-2</a> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/operating-systems/">Operating Systems</a> <a class="post-tag" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AF%BC%E8%AE%BA/">操作系统导论</a> <a class="post-tag" href="/tags/c/">C++</a> <a class="post-tag" href="/tags/dao/">DAO</a> <a class="post-tag" href="/tags/database/">database</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/vscode/">vscode</a> <a class="post-tag" href="/tags/shell/">shell</a> <a class="post-tag" href="/tags/5g/">5G</a> <a class="post-tag" href="/tags/btrfs/">btrfs</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/zh.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-VEN4M3BMXV"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-VEN4M3BMXV'); }); </script>
